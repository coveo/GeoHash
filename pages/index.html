<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height">
    <title>Coveo Map</title>

    <link rel="icon" type="image/png" href="https://labs.coveodemo.com/icons/coveo.png">

    <link rel="stylesheet" href="./css/CoveoFullSearch.css" />
    <!--<link rel="stylesheet" href="https://labs.coveodemo.com/demo/page.css"/>-->
    <link rel="stylesheet" href="./css/coveoextension.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script class="coveo-script" src="js/CoveoJsSearch.Lazy.js"></script>
    <script src="js/coveo.googleMap.extension.js"></script>
    <script src="js/templates/templates.js"></script>
    <script src="markerclusterer.js"></script>
    <link rel="stylesheet" type="text/css" href='https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css'>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,600&display=swap" rel="stylesheet">
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=YOUR-GOOGLE-KEY" async defer></script>
    <!-- for datepicker -->
    <!--<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />-->
    <!-- end for datepicker -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
          const addRecommendationPadding =  "{\"padding\": \"trending\" }";
            Coveo.SearchEndpoint.endpoints['default'] = new Coveo.SearchEndpoint({
                restUri: 'https://platform.cloud.coveo.com/rest/search',
                accessToken: 'YOUR-TOKEN',
            });
            Coveo.SearchEndpoint.endpoints['default'].options.queryStringArguments.mlParameters = addRecommendationPadding;
        })
    </script>

    <script>
      $(function() {

        const toggleFilters = () => {
          const widgetBtn =  document.querySelector('.widget-filters');
          widgetBtn.addEventListener('click', function(e) {
            //document.querySelector('.main-container').top = widgetBtn.offsetTop + 100+'px';
            document.querySelector('.main-container').classList.toggle('active-facets');

          });
        }

        toggleFilters();

        var root = document.body;
           /* globals Coveo */
            //Get the binding to the current resultlist.
            const addToUrl = activeTab => {
              let url = document.location.href;
              if (activeTab) {
                let hash = document.location.hash.substr(1); // remove first #
                hash = hash.replace(/&?\bt=(\w+)(&|$)/g, '$2'); // replace t=tabX& with &

                hash = '#t=' + activeTab + '&' + hash; // add new tab
                hash = hash.replace(/&?\b(hd|hq)=\S*?(&|$)/g, '$2'); // remove hd and hq parameters

                hash = hash.replace(/&&+/g, '&');
                url = document.location.origin + document.location.pathname + hash;
              }

              return url;
            };
        const GetBindings = () => {
          return Coveo.$('.CoveoResultList').coveo('getBindings');
        };
        const $$ = Coveo.$$;
        const usersMap = {
          Business: {
            sel: 'Business',
            help:
              ``,
            booster:
              `@uri`,
            musicbooster: ` $qre(expression: '@mygenre=Rock @mytype=Music',modifier:'-500', isConstant:'true')`
          },
          Family: {
            sel: 'Family',
            help:
              ``,
            booster:
              `@uri`,
            musicbooster: ` $qre(expression: '@mygenre=Rock @mytype=Music',modifier:'-500', isConstant:'true')`
          },
          Individual: {
            sel: 'Individual',
            help:
              ``,
            booster:
              `@uri`,
            musicbooster: ''
          }
        };
        const COOKIE_KEY = 'cur_user';

        const getUser = () => {
          let user = Coveo.Cookie.get(COOKIE_KEY) || 'Individual';
          if (window.USERS_MAP && !window.USERS_MAP[user]) {
            // validate it exists in this context; it may not when changing from intranet to public demos.
            user = 'Individual';
          }
          return user;
        };


        class MyUserToggle extends Coveo.Component {
          constructor(element) {
            super(element, MyUserToggle.ID);
            this.opened = false;
            this.active = true;
            this.initDom();
            this.setUser(getUser());
            this.bind.onRootElement('buildingQuery', args => this.handleBuildingQuery(args));
            this.bind.onRootElement('changeAnalyticsCustomData', args => this.handleModifyAnalytics(args));
          }

          toggle(opened) {
            this.opened = !this.opened;
            if (opened !== undefined) {
              this.opened = opened;
            }
            Coveo.$$(this.fieldset).toggle(this.opened);
          }

          handleBuildingQuery() {
            const userDefinition = window.CURRENT_USER_PROFILE;
            if (this.active) {
              //Coveo.state(this.root, 'hd', userDefinition.help.split('<BR>')[0]);
              //Coveo.state(this.root, 'hq', userDefinition.booster);
              this.active = !this.active;
            }
          }

          handleModifyAnalytics(args) {
            const userDefinition = window.CURRENT_USER_PROFILE;
            args.metaObject.user = userDefinition.sel;
            args.metaObject.role = userDefinition.sel;
          }

          initDom() {
            this.element.classList.add('coveo-my-toggle');

            Coveo.$$(this.element).text('User:');
            Coveo.$('.ion-chevron-down').on('click', () => this.toggle());
            this.dropdown = this.buildDropdown();
            this.fieldset = this.buildFieldSet();

            Coveo.$$(this.element).append(this.dropdown.el, this.fieldset.el);
          }

          setDropdownText(value) {
            const name = this.getName(value);
            this.dropdown.text(name);
          }

          buildDropdown() {
            const dropdown = Coveo.$$('div', {
              class: 'dropdown'
            });

            dropdown.on('click', () => this.toggle());
            return dropdown;
          }

          buildFieldSet() {
            const fieldSet = Coveo.$$('fieldset');
            Coveo.$$(this.element).append(fieldSet.el);

            Object.keys(window.USERS_MAP).forEach(k => {
              let label = this.buildLabel(k);
              fieldSet.append(label.el);
            });

            return fieldSet;
          }

          buildLabel(value) {
            const name = this.getName(value);
            const label = Coveo.$$('label', {}, name);
            label.addClass(`user-${value.replace(' ', '-')}`);

            label.on('click', () => this.setUser(value));

            return label;
          }

          getName(value) {
            let name = window.USERS_MAP[value].name || value;
            if (name === 'Individual') {
              name = 'Individual';
            }
            return name;
          }

          setUser(value) {
            if (!value || value === 'Individual') {
              value = 'Individual';
            }

            const cookval = Coveo.Cookie.get(COOKIE_KEY);
            var doReload = cookval !== value;
            if (cookval == null) {
              doReload=false;
              value = 'Individual';
              window.CURRENT_USER_PROFILE = window.USERS_MAP[value];
            }
            Coveo.Cookie.set(COOKIE_KEY, value);
            this.setDropdownText(value);

            this.dropdown.removeClass(['user-Individual', 'user-Business', 'user-Family']);
            $('body').removeClass(['Individual', 'Business','Family']);
            $('body').addClass(`${value}`);
            this.dropdown.addClass(`user-${value}`);
            if (doReload){
              if (value=='Individual'){
                //Move Price Up
                $('.CoveoFacetSlider').insertBefore($('.CoveoCategoryFacet[data-title="Type"]'));
                $('.CoveoFacet[data-title="Amenities"]').insertBefore($('.CoveoFacet[data-title="Bed type"]'));
                //$('.CoveoDynamicFacetSlider').prev().insertAfter($('.CoveoDynamicFacetSlider'));
              }
              else
              {
                //Move Price Down
                $('.CoveoFacetSlider').next().insertBefore($('.CoveoFacetSlider'));
                $('.CoveoFacet[data-title="Amenities"]').prev().insertAfter($('.CoveoFacet[data-title="Amenities"]'));
                $('.CoveoFacet[data-title="Amenities"]').prev().insertAfter($('.CoveoFacet[data-title="Amenities"]'));

              }
          }
            if (doReload) {
              this.active = true;
              this.toggle();
              window.CURRENT_USER_PROFILE = window.USERS_MAP[value];
              var customEventCause = { name: 'changeUser', type: 'search box' };
              $('#search').coveo('logSearchEvent', customEventCause, {});
              $('#search').coveo('executeQuery');
             // window.location.href = addToUrl(window.CURRENT_USER_PROFILE.activeTab);
             // window.location.reload();
            }
          }
        }

        MyUserToggle.ID = 'MyUserToggle';
        Coveo.Initialization.registerAutoCreateComponent(MyUserToggle);
       /**
        * Feature result (also isTopResult)
        * Is triggered in the query pipeline > Featured Results
        */
       class MyFeatured extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyFeatured.ID);

           this.options = Coveo.ComponentOptions.initComponentOptions(element, MyFeatured, options);
           if (result.isTopResult) {
             const badge = this.getBadge();
             const resultFrame = $$(this.element).closest('.coveo-result-frame');
             $$(resultFrame).prepend(badge.el);
           }
         }

         getBadge() {
           const container = this.getBadgeContainer();
           const highlight = this.getBadgeHighlight();
           const text = this.getBadgeText();
           highlight.append(text.el);
           container.append(highlight.el);
           return container;
         }

         getBadgeContainer() {
           const container = $$('div', {
             className: 'custom-coveo-badge'
           });
           container.el.style.position = 'relative';
           return container;
         }

         getBadgeText() {
           const text = $$(
             'div',
             {
               className: 'mytextFeatured'
             },
             'Featured'
           );
           return text;
         }

         getBadgeHighlight() {
           const highlight = $$('div', {
             className: 'coveo-result-highlight coveo-custom-featured'
           });

           return highlight;
         }
       }
       MyFeatured.ID = 'MyFeatured';
       Coveo.Initialization.registerAutoCreateComponent(MyFeatured);

       /* globals Coveo */
       const $$$1 = Coveo.$$;

       /**
        * ART result
        * Is triggered when ART (Machine Learning) is kicking in
        */
       class MyART extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyART.ID);
           if (result.isRecommendation) {
             const badge = this.getBadge();
             const resultFrame = $$$1(this.element).closest('.coveo-result-frame');
             $$$1(resultFrame).prepend(badge.el);
           }
         }

         getBadge() {
           const container = this.getBadgeContainer();
           const highlight = this.getBadgeHighlight();
           const text = this.getBadgeText();
           highlight.append(text.el);

           container.append(highlight.el);
           return container;
         }

         getBadgeContainer() {
           const container = $$$1('div', {
             className: 'custom-coveo-badge'
           });
           container.el.style.position = 'relative';
           return container;
         }

         getBadgeText() {
           const text = $$$1(
             'div',
             {
               className: 'mytextART'
             },
             'ML Boost'
           );
           return text;
         }

         getBadgeHighlight() {
           const highlight = $$$1('div', {
             className: 'coveo-result-highlight coveo-custom-ART'
           });

           return highlight;
         }
       }

       MyART.ID = 'MyART';
       Coveo.Initialization.registerAutoCreateComponent(MyART);

       /* globals Coveo */

       /**
        * Image result
        * Shows (external) image for Result
        */
       class MyImage extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyImage.ID);

           let imagePath = result.raw.myimage;
           if (imagePath) {
             let imagesPerTypeMap = {
               Houses: imagePath,
               Movie: `https://image.tmdb.org/t/p/w92${imagePath}`,
               Music: `//lastfm-img2.akamaized.net/i/u/64s/${imagePath}`,
               Concert: `//images.sk-static.com/images/media/profile_images/artists/${imagePath}/large_avatar`,
               People: `https://image.tmdb.org/t/p/w66_and_h66_bestv2${imagePath}`,
               'Movie People': `https://image.tmdb.org/t/p/w66_and_h66_bestv2${imagePath}`
             };
             imagePath = imagesPerTypeMap[result.raw.mytype] || imagePath;
             if (imagePath==undefined) imagePath='';
             imagePath = imagePath.replace('aki_policy=medium','aki_policy=large');
           }

           let divHtml = imagePath
             ? `<div class="myimage"><img src="${imagePath}" onerror="this.src='emptyP.png';" ></div>`
             : '<div class="noimage" style="width:92px;height:138px"></div>';
           Coveo.$(divHtml)
             /*.on('click', e => {
               $(e.target)
                 .closest('.coveo-result-frame').find('.CoveoQuickview')
                 .coveo('open');
             })*/
             .appendTo(element);
         }
       }

       MyImage.ID = 'MyImage';
       Coveo.Initialization.registerAutoCreateComponent(MyImage);

       //***************************
       //Image result for movie (Movie People)
       //  Shows an image from an external website. The field myimage is used as a reference
       //***************************
       class MyImageMovie extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyImageMovie.ID);
           this.element = element;
           this.options = Coveo.ComponentOptions.initComponentOptions(element, MyImageMovie, options);
           this.bindings = bindings;
           this.result = result;
           if (this.result.raw['mymovieimg']) {
             let imagePath = this.result.raw['mymovieimg'];
             imagePath = `https://image.tmdb.org/t/p/w92${imagePath}`;
             Coveo.$(`<img src="${imagePath}">`)
               .on('click', e => {
                 window.location = 'https://www.themoviedb.org/movie/' + this.result.raw['mymovieid'];
               })
               .appendTo(this.element);
           }
         }
       }

       MyImageMovie.ID = 'MyImageMovie';
       Coveo.CoveoJQuery.registerAutoCreateComponent(MyImageMovie);

       /* globals Coveo */

       /**
        * MyBackground result
        * Shows image/color background gradient on the result template
        */
       class MyBackground extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyBackground.ID);
           this.result = result;
           this.element = element;
           this.options = Coveo.ComponentOptions.initComponentOptions(element, MyBackground, options);
           if (this.options.showPoster) {
             this.addImage();
           }
         }

         addImage() {
           let url = this.result.raw.myimage;
           let imagesPerTypeMap = {
             Movie: `https://image.tmdb.org/t/p/w185_and_h278_bestv2/${url}`,
             Houses: `${url}`,
             Music: `//lastfm-img2.akamaized.net/i/u/174s/${url}`,
             Concert: `//images.sk-static.com/images/media/profile_images/artists/${url}/large_avatar`,
             People: `https://image.tmdb.org/t/p/w138_and_h175_face${url}`,
             'Movie People': `https://image.tmdb.org/t/p/w138_and_h175_face${url}`
           };

           let imageUrl = imagesPerTypeMap[this.result.raw.mytype];
           if (imageUrl==undefined) imageUrl='';
           imageUrl = imageUrl.replace('aki_policy=medium','aki_policy=large');
           if (imageUrl && !url) {
             // right type (Movie, Music, Concert) but a specific image wasn't set.
             imageUrl = 'https://elastic.coveodemo.com/icons/noimage-nofill.png';
           }
           if (!imageUrl) {
             return;
           }
           if (this.options.showUser) {
             $(this.element)
               .closest('.results-card__img-container')
               .css('background-image', `url(${imageUrl})`)
               .on('click', e => {
                 if (e.target.className == 'coveo-result-frame people') {
                   var internal = false;
                   if (this.result.raw.mytype === 'People') {
                     internal = true;
                   }
                   document.showUser(this.result.raw.sfcontactemail, internal);
                   return false;
                 }
               });
           } else {
             $(this.element)
               .closest('.results-card__img-container')
               .css('background-image', `url(${imageUrl})`)
               .on('click', e => {
                 //debugger;
                 $(e.target.parentElement)
                   .find('.CoveoQuickview')
                   .coveo('open');
               });
           }
         }


       }

       MyBackground.ID = 'MyBackground';
       MyBackground.options = {
         showPoster: Coveo.ComponentOptions.buildBooleanOption({ defaultValue: false }),
         showUser: Coveo.ComponentOptions.buildBooleanOption({ defaultValue: false })
       };
       Coveo.Initialization.registerAutoCreateComponent(MyBackground);

       /* globals Coveo */
       /**
        * Details and Related
        * Shows tabs with RelatedResults. Tabs are shown based upon the key field
        */
        class MyDetailsAndRelated extends Coveo.Component {
          constructor(element, options, bindings, result) {
            super(element, MyDetailsAndRelated.ID);
            this.options = Coveo.ComponentOptions.initComponentOptions(element, MyDetailsAndRelated, options);
            let $el = $(element);
            this.$parent = $el.parent();
            let $tabs = [$(`<div class="RelatedTab" data-name="Details" title="Details">Details</div>`)];
            let queries = [];

            $('.CoveoMyResultsRelated', this.$parent).each((i, el) => {
              let tabName = el.dataset.name;

              let fields = (el.dataset.fields || '').split(';');

              let skip = fields.length ? true : false; // default to false if no data-fields is set.
              fields.forEach(f => {
                // Validate that if we have data-fields set on a tab, the result has it.
                // For example, Don't show tab Music if there are no artist or song associated to a movie.
                if (result && result.raw && result.raw[f]) {
                  skip = false;
                }
              });

              //Fill the queries to check for results later on
              queries.push({ result: result, dataset: el.dataset, tab: tabName, parent: this.$parent });

              if (!skip) {
                //Check if there are results on the tab
                $tabs.push($(`<div class="RelatedTab" data-name="${tabName}" title="${tabName}">${tabName}</div>`));
              }
            });
            //Check if we have results for each of the tabs
            this.checkQueries(queries);

            $el.prepend($tabs);

            this.result = result;
            this.$el = $el;

            $('.RelatedTab', $el).on('click', e => {
              $('.RelatedTab.active', $el).removeClass('active');
              $(e.target).addClass('active');
              let name = e.target.dataset.name;
              $('.related-content', this.$parent).hide();

              let $newTab = $('.related-content.' + name, this.$parent);
              if ($newTab.length) {
                $newTab.show();
                if (!$newTab.hasClass('query-done')) {
                  $newTab.addClass('query-done');
                  Coveo.$($newTab).coveo('showMoreResults');
                }
              }
            });

            $('.RelatedTab[data-name="Details"]', $el).addClass('active');
          }

          //***************************
          //composeQuery
          //  Creates a new query for the checkQuery function
          //***************************
          composeQuery(result, dataset) {
            let newquery = dataset.query;
            let a = dataset.fields.split(';');
            let i = 0;
            for (i = 0; i < a.length; i++) {
              let fieldcontent = result.raw[a[i]];
              if (fieldcontent) {
                fieldcontent = '' + fieldcontent; //make sure it's a string
                //Workaround for the bad title with the place in it
                fieldcontent = fieldcontent.replace(/\(.*\)/g, '');
                //Seems that if you format the field in the UI, it gets the formatted value
                fieldcontent = fieldcontent.replace(/[;()]/g, ' ');

                //Comma's must be replaced by ","
                fieldcontent = fieldcontent.replace(/,/g, '","');
                //In Elastic the : means a field query
                newquery = newquery.replace('[FIELD' + (i + 1) + ']', fieldcontent.replace(':', ' '));
              } else {
                newquery = newquery.replace('[FIELD' + (i + 1) + ']', '');
              }
            }
            //ugly but for now fine, you would normally do this in a IPE or just before indexing.
            newquery = newquery.replace('movie script - Screenplays for You', '');
            return newquery;
          }

          //***************************
          //checkQuery
          //  Checks the query for all the relatedTabs. Based upon the groupby fields the tab will be made visible or not
          //***************************
          checkQuery(fields, query, partial, dataset) {
            let queryBuilder = new Coveo.QueryBuilder();
            queryBuilder.locale = GetBindings().queryController.lastQueryBuilder.locale;
            queryBuilder.pipeline = this.options.pipeline;
            queryBuilder.searchHub = 'CheckTabs';
            queryBuilder.enableDebug = false;
            queryBuilder.enableQuerySyntax = true;
            queryBuilder.enableDuplicateFiltering = false;
            queryBuilder.excerptLength = 200;

            queryBuilder.timezone = GetBindings().queryController.lastQueryBuilder.timezone;
            queryBuilder.numberOfResults = 0;
            queryBuilder.groupByRequests = fields;

            queryBuilder.expression.add(query);
            if (partial === 'true') {
              queryBuilder.enablePartialMatch = true;
              queryBuilder.partialMatchKeywords = 4;
              queryBuilder.partialMatchThreshold = '50%';
            }
            GetBindings()
              .queryController.getEndpoint()
              .search(queryBuilder.build())
              .done(function(data) {
                dataset.forEach(f => {
                  if (f.dataset.partialMatch === partial && f.dataset.keyCheck) {
                    //Check if we have the key in the result, if so enable the tab else disable it
                    let value = f.dataset.keyCheck.split(';')[1];
                    let found = false;
                    data.groupByResults.forEach(res => {
                      res.values.forEach(groupval => {
                        if (groupval.value.toLowerCase() === value.toLowerCase()) {
                          //We have it
                          found = true;
                        }
                      });
                    });
                    let $newTab = $('.RelatedTab[data-name="' + f.tab + '"]', f.parent);
                    if (found) {
                      $newTab.show();
                    } else {
                      $newTab.hide();
                    }
                  }
                });
              });
          }

          doWeHaveIt(tocheck, value) {
            let wehaveit = false;
            $.each(tocheck, function(index, obj) {
              if (obj.field === value) {
                wehaveit = true;
              }
            });
            return wehaveit;
          }

          //***************************
          //  checkQueries
          //  builds up the total query to execute for the relatedTabs
          //***************************
          checkQueries(queries) {
            // Partial match queries
            let checkQueriesWithPartialMatch = partialMatch => {
              let fields = [];
              let query = [];

              queries.forEach(f => {
                if (f.dataset.partialMatch === partialMatch && f.dataset.keyCheck) {
                  // Build a single query with an OR on all queries
                  // The key will be used to check if we have results
                  // Add keyfield to fields to retrieve
                  let field = f.dataset.keyCheck.split(';')[0];
                  if (!this.doWeHaveIt(fields, field)) {
                    fields.push({ field, sortCriteria: 'nosort' });
                  }
                  query.push('(' + this.composeQuery(f.result, f.dataset) + ')');
                }
              });
              if (query.length) {
                this.checkQuery(fields, query.join(' OR '), partialMatch, queries);
              }
            };

            checkQueriesWithPartialMatch('true');
            checkQueriesWithPartialMatch('false');
          }
        }

        MyDetailsAndRelated.ID = 'MyDetailsAndRelated';
        MyDetailsAndRelated.options = {
         pipeline: Coveo.ComponentOptions.buildLocalizedStringOption()
        };
        Coveo.Initialization.registerAutoCreateComponent(MyDetailsAndRelated);

       /* globals Coveo */

       /**
        * Music image
        * Show MusicImage
        */
       class MyMusicImage extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyMusicImage.ID);

           let divHtml = '<div class="noimagemusic" style="width:64px;height:64px"></div>'; // default
           if (result.raw.myimage) {
             divHtml = `<div class="myimage"><img src="//lastfm-img2.akamaized.net/i/u/64s/${result.raw.myimage}"></div>`;
           }
           Coveo.$(divHtml).appendTo(element);
         }
       }
       MyMusicImage.ID = 'MyMusicImage';
       Coveo.Initialization.registerAutoCreateComponent(MyMusicImage);

       /* globals Coveo */

       /**
        * ImageSmall
        * Render small image
        */
       class MyImageSmall extends Coveo.Component {
         constructor(element, options, bindings, result) {
           super(element, MyImageSmall.ID);

           let imagePath = result.raw.myimage;
           if (imagePath) {
             let imagesPerTypeMap = {
               Movie: `https://image.tmdb.org/t/p/w45${imagePath}`,
               Houses: `${imagePath}`,
               Music: `//lastfm-img2.akamaized.net/i/u/34s/${imagePath}`,
               Concert: `//images.sk-static.com/images/media/profile_images/artists/${imagePath}/avatar`,
               People: `https://image.tmdb.org/t/p/w66_and_h66_bestv2${imagePath}`,
               'Movie People': `https://image.tmdb.org/t/p/w66_and_h66_bestv2${imagePath}`
             };
             imagePath = imagesPerTypeMap[result.raw.mytype] || '';
           }

           let divHtml = imagePath ? `<div class="myimage"><img src="${imagePath}"></div>` : '<div class="noimage" style="width:34px;"></div>';
           Coveo.$(divHtml)
             .on('click', e => {
               $(e.target)
                 .closest('.CoveoQuickview')
                 .coveo('open');
             })
             .appendTo(element);
         }
       }

       MyImageSmall.ID = 'MyImageSmall';
       Coveo.Initialization.registerAutoCreateComponent(MyImageSmall);

      var FieldnameAvail = "@mydateavail";
      var FieldnameAvailClean = "mydateavail";
      var NrOfMonths = 0;

      //Function to get the query to construct, based on the selected dates
      function getFullDates(min, max) {
        var result = "";
        var minDate = new Date(min);
        var maxDate = new Date(max);
        var NrofDays = 0;
        var one_day = 1000 * 60 * 60 * 24;
        NrOfMonths = maxDate.getMonth() - minDate.getMonth() + 1;
        NrofDays = Math.round((maxDate.getTime() - minDate.getTime()) / one_day);
        for (i = 0; i <= NrofDays-1; i++) {
          var check = new Date(minDate.getFullYear(), minDate.getMonth(), minDate.getDate() + i);
          //Do not add saturday and sundays
          if (check.getDay() % 6 == 0) {}
          else {
            if (result == "") {
              result = FieldnameAvail + "=\"" + moment(check).format('YYYYMMDD') /*+ Hours.ToString() */ + "\"";
            } else {
              result = result + " AND " + FieldnameAvail + "=\"" +moment(check).format('YYYYMMDD') /*+ Hours.ToString() */ + "\"";
            }
          }
        }
        return result;
      }

       /* globals Coveo, musicBoost */

       let _my_location_promise = null;

       let getLocation = () => {
         if (!_my_location_promise) {
           _my_location_promise = new Promise(resolve => {
             $.get(
               'https://ipinfo.io',
               response => {
                 let globalNear = [response.city, response.region, response.country].join(', ');
                 resolve(globalNear);
               },
               'jsonp'
             );
           });
         }
         return _my_location_promise;
       };

       /**
        * Results Related
        * Shows related results based upon the current result, a new query is executed
        */
        class MyResultsRelated extends Coveo.Component {
          constructor(element, options, bindings, result) {
            super(element, MyResultsRelated.ID);
            this.showingMoreResults = false;
            this.result = result;
            this.options = Coveo.ComponentOptions.initComponentOptions(element, MyResultsRelated, options);
            $(element)
              .addClass('related-content ' + this.options.name)
              .hide();

            Coveo.Assert.exists(result);
            this.buildElements();
            this.updateElementVisibility();
            if (options.alwaysShow) {
              this.showMoreResults();
            }
          }

          buildElements() {
            let _this = this;
            _this.buildHeader();
            _this.buildResults();
          }

          showMoreResultsExternal() {
            getLocation().then(this._showMoreResultsExternal.bind(this));
          }

          _showMoreResultsExternal(globalnear) {
            //Getting results from an external source (NOT Coveo)
            //This is very tailored towards getting Movie Tickets from Google
            let _this = this;
            let newquery = this.options.query;
            let a = this.options.fields.split(';');
            let allfieldsmissing = true;
            for (let i = 0; i < a.length; i++) {
              let fieldcontent = this.result.raw[a[i]];
              let reFieldName = new RegExp(`\\[FIELD${i + 1}\\]`, 'g'); // to replace all [FIELD#]

              if (fieldcontent) {
                allfieldsmissing = false;
                fieldcontent = '' + fieldcontent; //make sure it's a string
                //Seems that if you format the field in the UI, it gets the formatted value
                //Workaround for the bad title with the place in it
                fieldcontent = fieldcontent.replace(/\(.*\)/g, '');
                fieldcontent = fieldcontent.replace(/[;()]/g, ' ');
                //Comma's must be replaced by ","
                fieldcontent = fieldcontent.replace(/,/g, '","');
                //In Elastic the : means a field query
                fieldcontent = fieldcontent.replace(':', ' ');
              }
              newquery = newquery.replace(reFieldName, fieldcontent || '');
            }

            if (allfieldsmissing) {
              // fieldcontent is invalid or missing, the query will return everything.
              // So we show "No related" instead.
              this.updateElementVisibility(0);
              return false;
            }
            var torender = '';
            var divtoget = this.options.divToGet;
            var titlecaption = this.options.titleCaption.replace('{LOC}', globalnear);
            var notitle = this.options.noResultsCaption.replace('{LOC}', globalnear);
            var results = this.results;
            newquery = newquery.replace('{LOC}', globalnear);
            Coveo.$(`<div class="movieloc"/>`)
              .html('Looking for movies near: ' + globalnear + ' in Google.')
              .appendTo(results);
            //var url = 'https://secret-ocean-49799.herokuapp.com/' + encodeURIComponent(newquery) + '';//'http://www.whateverorigin.org/get?url=' + encodeURIComponent(newquery) + '';
            var url = 'https://cors-anywhere.herokuapp.com/' + (newquery) + '';//'http://www.whateverorigin.org/get?url=' + encodeURIComponent(newquery) + '';
            $.get(url, function(response) {
              var xpath = divtoget.split(';');
              // var json=$.parseJSON(response.contents);
              var html = $('<html>').html(response);//response.contents);
              var dates = $(xpath[0], html);
              torender = '';
              if (dates.length >= 1) {
                //dates.first(r=>{
                //torender+="<tr width=300px><td colspan=2>"+$(dates[r]).find('div').first().attr('data-date')+"</td></tr>";
                //Location name
                var locs = $(dates[0]).find(xpath[1]);
                locs.each(l => {
                  let $loc = $(locs[l]).find(xpath[2]);
                  torender += `<tr width="300px"><td>
          <a target="_blank" class="smallhref" href="https://www.google.com/${$loc.attr('href')}">${$loc.text()}</a>
      </td><td>`;
                  //View times
                  var times = $(locs[l]).find(xpath[3]);
                  times.each(t => {
                    torender += '' + times[t].innerText + '&nbsp;&nbsp;';
                  });
                  torender += '</td></tr>';
                });
                //});
              }
              //torender = getElementsByXPath( xpath[0], html);

              //console.log(torender);
              if (torender) {
                _this.showingMoreResults = true;
                _this.updateElementVisibility(1);
                this.showExpand = Coveo.$(`<div class="movieplay"/>`)
                  .html(
                    `${titlecaption}<br><table cellpadding="3"><th style="text-align: left;">Cinema</th><th style="text-align: left;">Showtimes</th>${torender}</table>`
                  )
                  .appendTo(results);
              } else {
                _this.updateElementVisibility(0);
                _this.results.empty();
                this.noResultsCaption = Coveo.$('<div/>')
                  .addClass('coveo-folding-header-caption')
                  .html(notitle)
                  .appendTo(results);
              }
            });
          }

          preventEventPropagation() {
           this.preventEventPropagationOn(Coveo.QueryEvents);
           this.preventEventPropagationOn(Coveo.OmniboxEvents);
           this.preventEventPropagationOn(Coveo.ResultListEvents);
           this.preventEventPropagationOn(Coveo.SettingsEvents);
           this.preventEventPropagationOn(Coveo.PreferencesPanelEvents);
           this.preventEventPropagationOn(Coveo.AnalyticsEvents);
           this.preventEventPropagationOn(Coveo.BreadcrumbEvents);
           this.preventEventPropagationOn(Coveo.QuickviewEvents);
           this.preventEventPropagationOn(Coveo.InitializationEvents);
       }
       preventEventPropagationOn(eventType, eventName) {
           if (eventName === void 0) { eventName = function (event) {
               return event;
           }; }
           for (var event_1 in eventType) {
               Coveo.$$(this.root).on(eventName(event_1), function (e) { return e.stopPropagation(); });
           }
       }
          showMoreResults() {
            let _this = this;
            this.updateElementVisibility();
            this.preventEventPropagation();
            this.showingMoreResults = true;

            if (this.options.keyCheck) {
              let queryBuilder = new Coveo.QueryBuilder();
              //Copy settings from last Query Builder
              let binding = GetBindings();
              queryBuilder.locale = binding.queryController.lastQueryBuilder.locale;
              queryBuilder.pipeline = this.options.pipeline;//'default';//binding.queryController.lastQueryBuilder.pipeline;
              queryBuilder.searchHub = binding.queryController.lastQueryBuilder.searchHub;
              queryBuilder.sortCriteria = binding.queryController.lastQueryBuilder.sortCriteria;
              queryBuilder.enableDebug = binding.queryController.lastQueryBuilder.enableDebug;
              queryBuilder.enableQuerySyntax = true;
              queryBuilder.enableDuplicateFiltering = true;
              queryBuilder.excerptLength = binding.queryController.lastQueryBuilder.excerptLength;
              queryBuilder.addContext({
               userRole: window.CURRENT_USER_PROFILE.sel,
               userrole: window.CURRENT_USER_PROFILE.sel
             });
              queryBuilder.timezone = binding.queryController.lastQueryBuilder.timezone;
              queryBuilder.numberOfResults = this.options.numberOfResults;
              let newquery = this.options.query;
              let dq = this.options.dq;
              let a = this.options.fields.split(';');
              let i = 0;
              this.expandedComment = this.options.expandedComment;
              this.expandedQuery = this.options.expandedQuery;
              let allfieldsmissing = true;
              for (i = 0; i < a.length; i++) {
                let fieldcontent = this.result.raw[a[i]];
                let reFieldName = new RegExp(`\\[FIELD${i + 1}\\]`, 'g'); // to replace all [FIELD#]

                let fieldExpr = '';
                let fieldExprES = '';
                if (fieldcontent) {
                  allfieldsmissing = false;
                  fieldcontent = '' + fieldcontent; //make sure it's a string
      //Workaround for the bad title with the place in it
      fieldcontent = fieldcontent.replace(/\(.*\)/g, '');
                  //Seems that if you format the field in the UI, it gets the formatted value
                  fieldExpr = fieldcontent.replace(/[;()]/g, ' ');

                  //In Elastic the : means a field query
                  fieldExprES = fieldExpr.replace(':', ' ');
                  //Comma's must be replaced by ","
                  fieldExprES = fieldcontent.replace(/,/g, '","');
                }
                //In Elastic the : means a field query
                newquery = newquery.replace(reFieldName, fieldExprES);
                if (this.options.dq){
                  dq= dq.replace(reFieldName, fieldExprES);
                }
                this.expandedQuery = this.expandedQuery.replace(reFieldName, fieldExprES);
                this.expandedComment = this.expandedComment.replace(reFieldName, fieldExpr);
              }
              if (allfieldsmissing) {
                // fieldcontent is invalid or missing, the query will return everything.
                // So we show "No related" instead.
                this.updateElementVisibility(0);
                return false;
              }
              if (this.options.filterField) {
                queryBuilder.filterField = this.options.filterField;
              }
              if (this.result.state) {
                newquery = newquery.replace('[QUERY]', this.result.state['q']);
                this.expandedQuery = this.expandedQuery.replace('[QUERY]', this.result.state['q']);
              }
              if (this.options.dq){
               queryBuilder.disjunctionExpression.add(dq);
              }
              if (this.options.extraBoost && window.musicBoost) {
                // TODO - Move musicBoost in a Global User object
                queryBuilder.expression.add(newquery + musicBoost);
                _this.expandquery = newquery + musicBoost;
              } else {
                queryBuilder.expression.add(newquery);
                _this.expandquery = this.expandedQuery || newquery;
              }

              if (this.options.partialMatch) {
                queryBuilder.enablePartialMatch = true;
                queryBuilder.partialMatchKeywords = 4;
                queryBuilder.partialMatchThreshold = '50%';
              }
              GetBindings()
                .queryController.getEndpoint()
                .search(queryBuilder.build())
                .done(function(data) {
                  _this.showingMoreResults = true;
                  _this.updateElementVisibility(data.results.length);
                  _this.displayThoseResults(data.results);
                  //return !data.results.length === 0;
                });
            } else {
              _this.showMoreResultsExternal();
            }
          }

          expandQuery() {
            Coveo.$('.CoveoFacet').coveo('reset');
            Coveo.$('#search').coveo('state', 'hd', this.expandedComment);
            Coveo.$('#search').coveo('state', 'hq', this.expandquery);
            Coveo.$('#search').coveo('state', 'q', '');
            //Seems we are not executing analytics if we call executeQuery directly
            var customEventCause = { name: 'expand ' + this.options.name, type: 'search box' };
            Coveo.$('#search').coveo('logSearchEvent', customEventCause, {});
            Coveo.$('#search').coveo('executeQuery');
          }

          buildHeader() {
            this.header = Coveo.$('<div/>')
              .addClass('coveo-folding-header')
              .appendTo(this.element);
          }
          buildResults() {
            this.results = Coveo.$('<div/>')
              .addClass('coveo-folding-results2')
              .appendTo(this.header);
            this.noResultsCaption = Coveo.$('<div/>')
              .addClass('coveo-folding-header-caption')
              .text(this.options.noResultsCaption)
              .appendTo(this.results);
          }
          updateElementVisibility(subResultsLength) {
            this.noResultsCaption.hide();
            if (subResultsLength === 0) {
              this.noResultsCaption.show();
            }
          }

          scrollToResultElement() {
            Coveo.$(window).scrollTop(
              Coveo.$(this.element)
                .closest('.CoveoResult')
                .position().top
            );
          }

          displayThoseResults(results) {
            let _this = this;
            this.results.empty();
            if (results.length === 0) {
              this.noResultsCaption = Coveo.$('<div/>')
                .addClass('coveo-folding-header-caption')
                .text(this.options.noResultsCaption)
                .appendTo(this.results);
            } else {
              this.showExpand = Coveo.$(`<div class="coveo-folding-footer-section-for-less"/>`).click(_this.expandQuery.bind(_this));

              let help = this.options.help;
              if (help) {
                this.showExpand.hover(onMouseOverHelp.bind(null, help), onMouseOutHelp.bind(null, help));
              }

              let $a = Coveo.$(`<a class="coveo-folding-show-more">Expand to: ${this.expandedComment}</a>`);
              this.showExpand.append($a);

              this.showExpand.appendTo(this.results);
            }
           /* debugger;
            const container = document.querySelector(`.coveo-folding-results2`);
       container.innerHTML = 'Wim';
            const ResultList = Coveo.get(document.querySelector('.CoveoResultList'));// as Coveo.ResultList;
       ResultList.buildResults(results).then(async (elements) => {
         for (let element of elements) {
           container.append(element);
         }
       });*/
       //debugger;
            Coveo._.each(results, function(result) {
              result.raw.collection = result.raw.collection || 'default';
              _this.renderChildResult(result);
            });
          }

          renderChildResult(childResult) {
            let binding = GetBindings();
            Coveo.QueryUtils.setStateObjectOnQueryResult(binding.queryStateModel.get(), childResult);
            Coveo.QueryUtils.setSearchInterfaceObjectOnQueryResult(binding.searchInterface, childResult);

            let addToContainer = (container, childResult) => {
              if (container) {
                this.autoCreateComponentsInsideResult(container, childResult);
                Coveo.$(container).addClass('coveo-result-attachments-container CoveoResult');
                this.results.append(container);
              }
            };

            let containerOrPromise = this.options.resultTemplate.instantiateToElement(childResult,{
             wrapInDiv: true,
             checkCondition: true,
             currentLayout: 'list',
             responsiveComponents: binding.searchInterface.responsiveComponents}); // Promise on JSUI2 ?
            if (containerOrPromise && containerOrPromise.then) {
              containerOrPromise.then(container => {
                addToContainer(container, childResult);
              });
            } else {
              addToContainer(containerOrPromise, childResult);
            }
          }

          autoCreateComponentsInsideResult(element, result) {
            //return Coveo.Initialization.automaticallyCreateComponentsInsideResult(element, result);
            Coveo.Assert.exists(element);
            let initOptions = GetBindings().searchInterface.options;
            initOptions = _.extend({}, initOptions, { closeModalBox: false });
            let initParameters = { options: initOptions, bindings: GetBindings(), result: result };
            //Coveo.CoveoJQuery.automaticallyCreateComponentsInside(element, initParameters, [MyResultsRelated.ID]);
            Coveo.Initialization.automaticallyCreateComponentsInside(element, initParameters, [MyResultsRelated.ID]);
          }
        }

        MyResultsRelated.ID = 'MyResultsRelated';
        MyResultsRelated.options = {
          resultTemplate: Coveo.ComponentOptions.buildTemplateOption({
            defaultFunction: function() {
              return new Coveo.DefaultResultTemplate();
            }
          }),
          name: Coveo.ComponentOptions.buildLocalizedStringOption(),
          label: Coveo.ComponentOptions.buildLocalizedStringOption(),
          pipeline: Coveo.ComponentOptions.buildLocalizedStringOption(),
          dq: Coveo.ComponentOptions.buildLocalizedStringOption(),
          normalCaption: Coveo.ComponentOptions.buildLocalizedStringOption(),
          titleCaption: Coveo.ComponentOptions.buildLocalizedStringOption(),
          expandedComment: Coveo.ComponentOptions.buildLocalizedStringOption(),
          expandedQuery: Coveo.ComponentOptions.buildStringOption({ defaultValue: '' }),
          help: Coveo.ComponentOptions.buildStringOption({ defaultValue: '' }),
          expandedCaption: Coveo.ComponentOptions.buildLocalizedStringOption(),
          noResultsCaption: Coveo.ComponentOptions.buildLocalizedStringOption(),
          query: Coveo.ComponentOptions.buildStringOption(), // The Advanced query to execute, fields are noted as [FIELD1][FIELD2] from the fields section
          fields: Coveo.ComponentOptions.buildStringOption(), // The fields to use from the current result
          filterField: Coveo.ComponentOptions.buildStringOption(),
          keyCheck: Coveo.ComponentOptions.buildStringOption({ defaultValue: '' }),
          divToGet: Coveo.ComponentOptions.buildStringOption({ defaultValue: '' }),
          numberOfResults: Coveo.ComponentOptions.buildNumberOption(),
          partialMatch: Coveo.ComponentOptions.buildBooleanOption({ defaultValue: false }),
          extraBoost: Coveo.ComponentOptions.buildBooleanOption({ defaultValue: false }),
          alwaysShow: Coveo.ComponentOptions.buildBooleanOption({ defaultValue: false }),
          indent: Coveo.ComponentOptions.buildNumberOption()
        };

        Coveo.Initialization.registerAutoCreateComponent(MyResultsRelated);



       window.USERS_MAP = usersMap;
       window.CURRENT_USER_PROFILE = usersMap[getUser()];
       $('body').addClass(window.CURRENT_USER_PROFILE.sel);
       $('#search').on('buildingQuery', function(e, args) {
        //A custom context is added so we can react on it in Query Pipelines and Analytics
        args.queryBuilder.addContext({
          userRole: window.CURRENT_USER_PROFILE.sel,
          userrole: window.CURRENT_USER_PROFILE.sel
        });
      });

       Coveo.init(root);

      });
    </script>
  </head>

<body id="search" class='CoveoSearchInterface' data-pipeline='Search' data-enable-history="true" data-auto-trigger-query="true" data-debug=true data-expression="" data-results-per-page='10'>

  <header class='header'>
    <div class='container'>
      <div class='header__left'>
        <img class="CoveoLogoOverlay" src="https://www.kayee.nl/wp-content/uploads/2016/05/coveo-logo.png" />
        <div class='coveo-search-section-wrapper'>
          <div class='coveo-search-section'>
              <div class="CoveoSearchbox" data-enable-omnibox="true" data-placeholder="" data-enable-query-syntax="true">
              </div>
          </div>
        </div>
        <div class="CoveoTriggers"></div>
      </div>
      <div>
        <div id="user-menu" class='show-md__above user-menu'>
          <div id="current-user">
            <div class="CoveoMyUserToggle"></div>

          </div>
          <i class="ionicons ion-chevron-down"></i>
        </div>
      </div>
    </div>
    <div class='custom-container--fluid summary-section'>
      <div class="CoveoBreadcrumb"></div>
    </div>
  </header>


  <div class="CoveoPromotedResultsBadge"
    data-show-badge-for-recommended-results="true"
    data-caption-for-recommended="Recommended by Coveo ML"
    data-caption-for-featured-results="Featured Result"
    data-show-badge-for-featured-results="true"
    data-color-for-featured-results="orange"
    data-color-for-recommended-results="green"></div>
  <div class='CoveoAnalytics'></div>
  <div class='main-container'>
    <div class='results-filter__column'>
      <!-- <div class="CoveoBreadcrumb mobile-breadcrumbs"></div> -->
      <div class='widget-filters__container'>
        <div class='widget-filters'>
          <i class="ionicons ion-funnel"></i>
          <span class='filters-title'>
            Filter Results
          </span>
        </div>
      </div>
      <div class='facet-container'>
        <div id="user-menu" class='show-md__below user-menu'>
          <div id="current-user">
            <div class="CoveoMyUserToggle"></div>
          </div>
          <i class="ionicons ion-chevron-down"></i>
        </div>
        <div class="coveo-facet-column">
          <div class="CoveoFacetSlider" data-title="Price Range" data-graph="true" data-start=1 data-end=400 data-graph-steps=60 data-display-as-value-unit-sign='$' data-range-slider='true' data-field="@myprice" data-date-field="false" ></div>
          <div class="CoveoCategoryFacet" data-title="Type" data-field="@myroomprop"></div>
          <div class="CoveoFacet" data-title="Amenities" data-field="@myamenities" ></div>
          <div class="CoveoFacet" data-title="Bed type" data-field="@mybedtype" ></div>
          <div class="CoveoFacet" data-title="Reviewed by Profile" data-field="@myratingtype" ></div>
          <div class="CoveoFacet" data-title="Reviewed by Age" data-field="@myratingage" ></div>
          <div class="CoveoFacet" data-title="Review" data-field="@myrating" data-sort-criteria="alphadescending" data-value-caption='{ "5": "&#9733;&#9733;&#9733;&#9733;&#9733;", "4": "&#9733;&#9733;&#9733;&#9733;","3":"&#9733;&#9733;&#9733;","2":"&#9733;&#9733;","1":"&#9733;" }'></div>
          <div class="CoveoFacet" data-title="No of Persons" data-field="@mynopersons" ></div>
        </div>
      </div>

      <div class="CoveoHiddenQuery"></div>
      <div class="CoveoDidYouMean"></div>
      <div class="CoveoErrorReport"></div>

      <div class="coveo-summary-section">
        <span class="CoveoQuerySummary"></span>
        <div class="coveo-sort-section">
          <span class="CoveoSort" data-sort-criteria="relevancy" data-caption="Relevance"></span>
          <span class="CoveoSort" data-sort-criteria="@myvotecount descending, @myvotecount ascending" data-caption="Votes"></span>
        </div>
      </div>

      <div class="CoveoResultList" data-layout="list" data-auto-select-fields-to-include="true">
        <script id="MovieTemplate" class="result-template" type="text/underscore" data-layout="list" data-field-mytype="Houses">
          {{
            var amenities = raw.myamenities;
          }}
          <div class="results-card">
            <!--<div class="results-card__img-container" style="background: url({{- raw.myimage.replace('aki_policy=medium','aki_policy=large')}})"> -->
              <div class="results-card__img-container">
                <span class="CoveoMyBackground" data-show-poster="true"></span>
            </div>
            <div class="results-card__main">
              <div class="CoveoFieldValue room-type widget-capsule" data-field="@myroomtype"></div>
              <a class="CoveoResultLink"></a>
              <div class='amenities'>
                <div class="CoveoExcerpt"></div>
                {{
                  var limit = amenities.length < 7 ? amenities.length : 7;
                  for(var i = 0; i < limit; i++) {
                  }}
                    <span class='amenities__item'> {{- amenities[i]}}</span>
                  {{
                  }
                }}
                <span>...</span>
              </div>
              <div class='results-card__footer'>
                <div class='reviews'>
                  <div class="CoveoQuickview" data-template-id="HouseQuickview"></div><span class="CoveoStarRating" data-rating-field="@myvotecount" data-rating-scale=100></span>
                  <span class="CoveoFieldValue" data-field="@myvotecount"></span>
                </div>
                <div class="CoveoFieldValue result-card__price" data-field="@myprice" data-text-caption="$"></div>
              </div>
            </div>
          </div>
        </script>

        <script id="Default" class="result-template" type="text/html" data-layout="list">
          <div class="coveo-result-frame movie" style="padding-left:5px;padding-top: 5px;">
            <div style="display: inline-block; width: 20%;padding-right: 10px;">
               <span class="CoveoMyImage" data-show-poster="true"></span>
            </div>
            <div style="display: inline-block; width: 75%;vertical-align: top;">
              <div class="result-float-right role-based-text-color">
                <span class="CoveoFieldValue" data-field="@date" data-helper="date"></span>
              </div>
              <a class="CoveoResultLink"></a>
              <div class="CoveoExcerpt"></div>
            </div>
          </div>

        </script>

        <script id="HouseQuickview" class="result-template" type="text/html" >
          <div class="coveo-quick-view-full-height">
            <div class="coveo-quick-view-header">
            </div>
            <div class="CoveoQuickviewDocument" style="height:60%"></div>
            <div class="CoveoMyDetailsAndRelated" data-pipeline='default'>
                <table class="CoveoFieldTable coveo-details related-content Details query-done" data-allow-minimization="false">
                    <tr data-field="@myproptype" data-facet='none' data-caption="Property type" data-html></tr>
                    <tr data-field="@myroomtype" data-facet='none' data-caption="Room type"></tr>
                    <tr data-field="@mybedtype" data-facet='none' data-caption="Bed Type"></tr>
                    <tr data-field="@myamenities" data-facet='none' data-caption="Amenities" data-split-values="true"></tr>
                </table>
              </div>

              <div class="CoveoMyResultsRelated Attractions coveo-details" data-result-template-id="Default" data-name="Attractions" data-normal-caption="Attractions"
                data-title-caption="Related attractions (based upon city)" data-expanded-caption="Hide Related Attractions" data-no-results-caption="No related attractions found"
                data-query='@mycity="[FIELD1]" @source==Attractions @myimage' data-key-check='@source;Attractions' data-expanded-comment="Show Attractions where city is '[FIELD1]'"
                data-extra-boost=false data-fields="mycity" data-partial-match=false data-number-Of-Results=5 data-help='' data-pipeline='default'>
              </div>

              <div class="CoveoMyResultsRelated News coveo-details" data-result-template-id="Default" data-name="News" data-normal-caption="News" data-title-caption="Related news (based upon country)"
                data-expanded-caption="Hide Related News" data-no-results-caption="No related news found" data-query='@mycountry="[FIELD1]" @documenttype==Article @myimage'
                data-key-check='@documenttype;Article' data-expanded-comment="Show News with country: [FIELD1] "
                data-extra-boost=false data-fields="mycountry" data-filter-field="" data-partial-match=false
                data-number-Of-Results=5 data-help=''  data-pipeline='default'>
              </div>
                <!-- coveo-results-column -->

                <div class="CoveoMyResultsRelated Rec coveo-details" data-result-template-id="MovieTemplate" data-name="Recommended" data-normal-caption="Recommended" data-title-caption="Recommended Houses"
                data-expanded-caption="Hide Recommendations" data-no-results-caption="No recommendations found" data-query='(@mycity="[FIELD1]" NOT @uri="[FIELD2]" @mytype==Houses) '
                data-key-check='@mtype;Houses' data-expanded-comment="Show Houses of city: [FIELD1] "
                data-extra-boost=false data-fields="mycity;uri" data-filter-field="" data-partial-match=false data-dq='@mytype==Houses NOT @uri="[FIELD2]"'
                data-number-Of-Results=5 data-help=''  data-pipeline='Recommendations'>
              </div>
            </div>
          </script>
        </div>
        <div class="CoveoPager"></div>
        <div class="CoveoResultsPerPage"></div>
    </div>

    <div class='main-column'>
      <div class="CoveoMapWraper">
        <div style="display:none">
          <div id="myprecision" style="display:inline-block;padding:5px;color:red;background-color:yellow;font-size:0.8em"></div>
          <div id="myquery" style="display:inline-block;padding:5px;color:red;background-color:yellow;font-size:0.8em"></div>
        </div>
        <div class="CoveoGeoHashMap" id="CoveoGeoHashMap" data-lat-field="mylat" data-lon-field="mylon" data-template-id="MovieTemplate"></div>
      </div>
    </div>
  </div>
</body>
</html>
